<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drawing Tablet Inventory</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f4f4f9;
        }

        h1 {
            color: #2c3e50;
            text-align: center;
        }

        h2 {
            color: #34495e;
            border-bottom: 2px solid #ddd;
            padding-bottom: 10px;
            margin-top: 40px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
        }

        th,
        td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #2c3e50;
            color: white;
            font-weight: bold;
        }

        tr:hover {
            background-color: #f1f1f1;
        }

        .error {
            color: red;
            font-weight: bold;
            text-align: center;
            padding: 20px;
            background: #ffe6e6;
            border: 1px solid #ffcccc;
            border-radius: 5px;
            margin: 20px 0;
            display: none;
        }

        .loading {
            text-align: center;
            font-style: italic;
            color: #666;
        }

        /* Tab Styles */
        .tabs {
            overflow: hidden;
            border-bottom: 1px solid #ccc;
            margin-bottom: 20px;
        }

        .tab-button {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 16px;
            transition: 0.3s;
            font-size: 17px;
            border-top-left-radius: 5px;
            border-top-right-radius: 5px;
        }

        .tab-button:hover {
            background-color: #ddd;
        }

        .tab-button.active {
            background-color: #ccc;
            font-weight: bold;
        }

        .tab-content {
            display: none;
            padding: 6px 12px;
            border: 1px solid #ccc;
            border-top: none;
            animation: fadeEffect 1s;
        }

        @keyframes fadeEffect {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .controls {
            margin-bottom: 5px;
            text-align: right;
        }

        select {
            padding: 8px;
            font-size: 16px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }

        .search-bar {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .search-bar input[type="text"] {
            flex: 1;
            padding: 8px 12px;
            font-size: 16px;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-family: inherit;
        }

        .search-bar input[type="text"]:focus {
            outline: none;
            border-color: #2c3e50;
            box-shadow: 0 0 0 2px rgba(44, 62, 80, 0.15);
        }

        .search-bar button {
            padding: 8px 14px;
            font-size: 15px;
            border-radius: 4px;
            border: 1px solid #ccc;
            background: #f4f4f9;
            cursor: pointer;
        }

        .search-bar button:hover {
            background: #ddd;
        }

        .search-hint {
            font-size: 12px;
            color: #888;
            margin-bottom: 8px;
        }
    </style>
</head>

<body>

    <h1>Drawing Tablet Inventory</h1>

    <div id="error-message" class="error"></div>
    <div id="loading-message" class="loading">Loading inventory data...</div>

    <div id="content" style="display: none;">
        <div class="search-bar">
            <label for="searchInput">Search:</label>
            <input type="text" id="searchInput" placeholder='e.g.  huion  GS1563  "pen display"  kam*' autocomplete="off">
            <button id="clearSearch" title="Clear search">&#x2715;</button>
        </div>
        <div class="search-hint">
            Multiple terms are ANDed. Use quotes for phrases: <code>"pen display"</code>. Use wildcards: <code>kam*</code>, <code>h?ion</code>.
        </div>
        <div class="controls">
            <label for="brandFilter">Filter by Brand:</label>
            <select id="brandFilter">
                <option value="all">All Brands</option>
            </select>
            <label for="typeFilter">Filter by Type:</label>
            <select id="typeFilter">
                <option value="all">All Types</option>
            </select>
            <label for="sortOrder">Sort by:</label>
            <select id="sortOrder">
                <option value="brand">Brand</option>
                <option value="modelId">Model ID</option>
                <option value="date">Order Date</option>
            </select>
            <select id="sortDirection">
                <option value="asc">Ascending</option>
                <option value="desc">Descending</option>
            </select>
            <span id="rowCount" style="margin-left: 15px; font-weight: bold; color: #555;"></span>
        </div>

        <div class="tabs">
            <button class="tab-button" onclick="openTab(event, 'Tablets')" id="defaultOpen">Tablets</button>
            <button class="tab-button" onclick="openTab(event, 'Pens')">Pens</button>
        </div>

        <div id="Tablets" class="tab-content">
            <table id="tablets-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Brand</th>
                        <th>Model Name</th>
                        <th>Model ID</th>
                        <th>Type</th>
                        <th>Inventory ID</th>
                        <th>Vendor</th>
                        <th>Order Date</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Rows will be inserted here -->
                </tbody>
            </table>
        </div>

        <div id="Pens" class="tab-content">
            <table id="pens-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Brand</th>
                        <th>Pen Name</th>
                        <th>Technology</th>
                        <th>Subtype</th>
                        <th>Inventory ID</th>
                        <th>With Tablet</th>
                        <th>Notes</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Rows will be inserted here -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let inventoryData = { Tablets: [], Pens: [] };
        let currentTab = 'Tablets'; // Default valid tab

        document.addEventListener('DOMContentLoaded', () => {
            const dbPath = 'db/7p_drawtab_inventory.json';

            fetch(dbPath)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    inventoryData = data;

                    document.getElementById('loading-message').style.display = 'none';
                    document.getElementById('content').style.display = 'block';
                    document.getElementById("defaultOpen").click(); // This will trigger openTab -> populateTypeFilter & populateBrandFilter
                })
                .catch(error => {
                    console.error('Error fetching inventory:', error);
                    const errorDiv = document.getElementById('error-message');
                    errorDiv.style.display = 'block';
                    errorDiv.innerHTML = `
                        Error loading inventory data: ${error.message}<br>
                        <small>Make sure you are running this page from a web server (e.g., using <code>python -m http.server</code>) to avoid CORS issues.</small>
                    `;
                    document.getElementById('loading-message').style.display = 'none';
                });

            document.getElementById('sortOrder').addEventListener('change', applySort);
            document.getElementById('sortDirection').addEventListener('change', applySort);
            document.getElementById('brandFilter').addEventListener('change', applySort);
            document.getElementById('typeFilter').addEventListener('change', applySort);
            document.getElementById('searchInput').addEventListener('input', applySort);
            document.getElementById('clearSearch').addEventListener('click', () => {
                document.getElementById('searchInput').value = '';
                applySort();
            });
        });

        function populateBrandFilter(activeTab) {
            const brands = new Set();
            const brandSelect = document.getElementById('brandFilter');
            const currentSelection = brandSelect.value; // Store current selection

            // internal helper
            const addBrands = (sourceData) => {
                sourceData.forEach(item => {
                    if (item.Brand) brands.add(item.Brand);
                });
            };

            if (activeTab === 'Tablets') {
                addBrands(inventoryData.Tablets);
            } else if (activeTab === 'Pens') {
                addBrands(inventoryData.Pens);
            }

            const sortedBrands = Array.from(brands).sort();

            // Clear and rebuild
            brandSelect.innerHTML = '<option value="all">All Brands</option>';

            sortedBrands.forEach(brand => {
                const option = document.createElement('option');
                option.value = brand;
                option.textContent = brand;
                brandSelect.appendChild(option);
            });

            // Smart Reset: Try to keep selection if valid, else reset
            if (currentSelection !== 'all' && brands.has(currentSelection)) {
                brandSelect.value = currentSelection;
            } else {
                brandSelect.value = 'all';
            }
        }

        function populateTypeFilter(activeTab) {
            const types = new Set();
            const typeSelect = document.getElementById('typeFilter');

            // internal helper to add options
            const addOptions = (sourceData, field) => {
                sourceData.forEach(item => {
                    if (item[field]) types.add(item[field]);
                });
            };

            if (activeTab === 'Tablets') {
                addOptions(inventoryData.Tablets, 'TabletType');
            } else if (activeTab === 'Pens') {
                addOptions(inventoryData.Pens, 'PenTech');
            }

            const sortedTypes = Array.from(types).sort();

            // Clear existing options except "All Types"
            typeSelect.innerHTML = '<option value="all">All Types</option>';

            sortedTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                typeSelect.appendChild(option);
            });

            // Reset to 'all'
            typeSelect.value = 'all';
        }

        // Parse a search query into an array of term matchers.
        // Supports: quoted phrases, * (any chars) and ? (single char) wildcards.
        // All terms are ANDed together.
        function parseSearchQuery(query) {
            const tokens = [];
            // Tokenise: quoted strings or non-whitespace runs
            const regex = /"([^"]*)"|\S+/g;
            let match;
            while ((match = regex.exec(query)) !== null) {
                // match[1] is set when the quoted group matched, else match[0]
                const raw = match[1] !== undefined ? match[1] : match[0];
                tokens.push(raw);
            }
            // Convert each token into a predicate function
            return tokens.map(token => {
                const lower = token.toLowerCase();
                // Build a regex from the token, treating * and ? as wildcards
                const hasWildcard = lower.includes('*') || lower.includes('?');
                if (hasWildcard) {
                    const escaped = lower.replace(/[.+^${}()|[\]\\]/g, '\\$&')
                                        .replace(/\*/g, '.*')
                                        .replace(/\?/g, '.');
                    const re = new RegExp('^' + escaped + '$');
                    return (text) => re.test(text.toLowerCase());
                } else {
                    return (text) => text.toLowerCase().includes(lower);
                }
            });
        }

        // Return true if item matches all search predicates across the given fields.
        function matchesSearch(item, fields, predicates) {
            if (predicates.length === 0) return true;
            return predicates.every(pred => {
                return fields.some(field => {
                    const val = item[field];
                    return val && pred(String(val));
                });
            });
        }

        function applySort() {
            const sortBy = document.getElementById('sortOrder').value;
            const sortDir = document.getElementById('sortDirection').value;
            const brandFilter = document.getElementById('brandFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;
            const searchQuery = document.getElementById('searchInput').value.trim();
            const predicates = parseSearchQuery(searchQuery);

            let filteredTablets = inventoryData.Tablets;
            let filteredPens = inventoryData.Pens;

            if (brandFilter !== 'all') {
                filteredTablets = filteredTablets.filter(item => item.Brand === brandFilter);
                filteredPens = filteredPens.filter(item => item.Brand === brandFilter);
            }

            if (typeFilter !== 'all') {
                filteredTablets = filteredTablets.filter(item => item.TabletType === typeFilter);
                filteredPens = filteredPens.filter(item => item.PenTech === typeFilter);
            }

            const tabletSearchFields = ['Brand', 'ModelName', 'ModelID', 'Vendor'];
            const penSearchFields = ['Brand', 'Pen'];
            filteredTablets = filteredTablets.filter(item => matchesSearch(item, tabletSearchFields, predicates));
            filteredPens = filteredPens.filter(item => matchesSearch(item, penSearchFields, predicates));

            // Update Row Count Display
            const rowCountSpan = document.getElementById('rowCount');
            let shownCount = 0;
            let totalCount = 0;

            if (currentTab === 'Tablets') {
                shownCount = filteredTablets.length;
                totalCount = inventoryData.Tablets.length;
            } else {
                shownCount = filteredPens.length;
                totalCount = inventoryData.Pens.length;
            }
            rowCountSpan.textContent = `Showing ${shownCount} of ${totalCount} items`;

            sortData(filteredTablets, sortBy, sortDir);
            sortData(filteredPens, sortBy, sortDir);

            renderTable('tablets-table', filteredTablets, [
                'Brand', 'ModelName', 'ModelID', 'TabletType', 'InventoryID', 'Vendor', 'OrderDate'
            ]);
            renderTable('pens-table', filteredPens, [
                'Brand', 'Pen', 'PenTech', 'PenTechSubtype', 'InventoryID', 'WithTablet', 'Notes'
            ]);
        }

        function sortData(items, criteria, direction) {
            items.sort((a, b) => {
                const brandA = (a.Brand || '').toLowerCase();
                const brandB = (b.Brand || '').toLowerCase();
                const nameA = (a.ModelName || a.Pen || '').toLowerCase();
                const nameB = (b.ModelName || b.Pen || '').toLowerCase();
                const modelIdA = (a.ModelID || a.Pen || '').toLowerCase();
                const modelIdB = (b.ModelID || b.Pen || '').toLowerCase();
                // Use OrderDate for tablets, dateCreated for Pens as fallback
                const dateA = a.OrderDate || a.dateCreated || 0;
                const dateB = b.OrderDate || b.dateCreated || 0;

                let comparison = 0;

                if (criteria === 'brand') {
                    // Brand -> Name -> Date
                    if (brandA < brandB) comparison = -1;
                    else if (brandA > brandB) comparison = 1;
                    else if (nameA < nameB) comparison = -1;
                    else if (nameA > nameB) comparison = 1;
                    else if (dateA < dateB) comparison = -1;
                    else if (dateA > dateB) comparison = 1;
                } else if (criteria === 'date') {
                    // Date -> Brand -> Name
                    if (dateA < dateB) comparison = -1;
                    else if (dateA > dateB) comparison = 1;
                    else if (brandA < brandB) comparison = -1;
                    else if (brandA > brandB) comparison = 1;
                    else if (nameA < nameB) comparison = -1;
                    else if (nameA > nameB) comparison = 1;
                } else if (criteria === 'modelId') {
                    // Model ID -> Brand -> Date
                    if (modelIdA < modelIdB) comparison = -1;
                    else if (modelIdA > modelIdB) comparison = 1;
                    else if (brandA < brandB) comparison = -1;
                    else if (brandA > brandB) comparison = 1;
                    else if (dateA < dateB) comparison = -1;
                    else if (dateA > dateB) comparison = 1;
                }

                return direction === 'desc' ? -comparison : comparison;
            });
        }

        function openTab(evt, tabName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tab-button");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";

            currentTab = tabName; // Update global state
            populateTypeFilter(tabName);
            populateBrandFilter(tabName);
            applySort(); // Re-apply sort/filter with new type options (which resets to all)
        }

        function renderTable(tableId, items, columns) {
            const tbody = document.querySelector(`#${tableId} tbody`);
            tbody.innerHTML = '';

            if (!items || items.length === 0) {
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.colSpan = columns.length;
                cell.textContent = 'No items found.';
                cell.style.textAlign = 'center';
                row.appendChild(cell);
                tbody.appendChild(row);
                return;
            }

            items.forEach((item, index) => {
                const row = document.createElement('tr');

                // Row Number Cell
                const indexCell = document.createElement('td');
                indexCell.textContent = index + 1;
                row.appendChild(indexCell);

                columns.forEach(col => {
                    const cell = document.createElement('td');
                    cell.textContent = item[col] || '-';
                    row.appendChild(cell);
                });
                tbody.appendChild(row);
            });
        }
    </script>

</body>

</html>